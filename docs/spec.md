# RHEED撮影・解析支援システム 要件定義書

## 1. システム概要

Basler社製産業用カメラを用い、RHEED（反射高速電子線回折）パターンのリアルタイムプレビューおよびマルチ条件での自動シーケンス撮影を行うシステム。
プレビュー時は視認性を高める画像処理（CLAHE）を適用可能とし、保存時は解析の定量性を完全に保証するため、pypylonの公式コンバータを介した**センサ生データ（Raw）**を出力する。

## 2. 動作環境・技術スタック

* **言語**: Python 3.x
* **GUIフレームワーク**: PySide6 (Qt)
* **カメラ制御**: pypylon (Basler Pylon SDK Wrapper)
* **画像保存・メタデータ処理**: tifffile
* **画像処理・数値計算**: OpenCV, NumPy
* **アーキテクチャ設計**: TDD（テスト駆動開発）に基づくレイヤードアーキテクチャ (Model-View-ViewModelベース)

## 3. ソフトウェアアーキテクチャ

責務を分離し、拡張性とテスト容易性を高める設計とする。

| モジュール名 | レイヤー | 役割・責務 |
| --- | --- | --- |
| **`CameraDevice`** | Model | ハードウェア制御 (pypylonラッパー)。パラメータ設定、MsbAligned適用、Min/Max取得。 |
| **`ImageProcessor`** | Model | 純粋な画像変換。CLAHE処理アルゴリズム。状態を持たない静的メソッド。 |
| **`ExperimentStorage`** | Model | 実験セッションのディレクトリ状態管理、連番管理、遅延作成ロジック。 |
| **`TiffWriter`** | Model | I/O専任。Numpy配列とJSONメタデータの非圧縮TIFF書き込み。 |
| **`AppSettings`** | Model | `settings.json` を用いたUI状態の保存・復元。 |
| **`PreviewWorker`** | ViewModel | 非同期スレッドでの継続的プレビュー取得・画像処理・UIへのシグナル送信。 |
| **`CaptureService`** | ViewModel | 非同期スレッドでの自動撮影制御。直積ループ生成、リトライロジックの管理。 |
| **`MainWindow`** | View | GUI表示、ユーザー入力のバリデーション、各Model/Workerへのイベント伝達。 |

## 4. カメラ・ハードウェア制御仕様

### 4.1 センサおよびピクセルフォーマット

* **PixelFormat**: `Mono16`
* **センサ有効ビット深度**: 12bit
* **ビットアライメント**: **`MsbAligned`** を適用。
* 12bitデータ(0〜4095)を16bitコンテナの上位に詰め、0〜65520のフルスケールとして出力する。これにより、Python側での手動ビットシフト演算を排除し、安全かつ一貫したデータ正規化を実現する。

### 4.2 強制初期化設定 (生データ保証)

接続時に以下の設定を強制し、カメラ側での余計な補正を無効化する。

* `ExposureAuto` = Off, `GainAuto` = Off, `BalanceWhiteAuto` = Off
* `Gamma` = 1.0, `BlackLevel` = 0.0, `LUTEnable` = False

## 5. 機能要件

### 5.1 プレビュー機能

* **取得ロジック**: 非同期スレッドによる `StartGrabbing(LatestImageOnly)`。
* **画像処理 (トグル式)**:
* **ON時**: CLAHE（Contrast Limited Adaptive Histogram Equalization）を分割数の異なる2段構成で適用。
* **OFF時**: MsbAligned化された16bitデータを8bitにダウンスケール（`>> 8`）して表示。

* **描画負荷への対応**: UIの応答性（ボタン操作等）を最優先とし、必要に応じてプレビューのフレームレート低下を許容する。

### 5.2 自動シーケンス撮影機能

* **撮影フロー**:

1. プレビューの完全停止 (`StopGrabbing`)。
2. 入力された露光時間(ms)リストとゲインリストを**それぞれ昇順にソートする**（カメラの安定性確保のため、小さい値から順に適用する）。
3. ソートされたリストの**直積（全組み合わせ）**を展開し、順次設定を適用。
4. `GrabOne()` を用いた同期取得。（※パイプラインが完全に停止・リセットされている状態での取得となるため、旧仕様の安定化用ダミー取得は不要とする）。
5. 撮影完了後、プレビューを自動再開。

* **キャンセルフラグ**: ユーザーによる即時中断（進行中の撮影ループ終了後に停止）をサポート。

### 5.3 データ・ディレクトリ管理機能

* **遅延作成 (Lazy Creation)**:
アプリ起動やルートフォルダ設定時点では空フォルダを作成せず、**実際に「Start Sequence」が実行された瞬間にのみ**必要なディレクトリツリーを構築する。
* **ブランチ(-n)の自動認識と手動更新**:
指定されたRoot内に本日の実験フォルダ(`yymmdd`)が存在する場合、既存の枝番(`yymmdd-n`)と内部の連番(`image_nnn`)を自動スキャンして続きから再開する。
GUI上の「New Branch」ボタンにより、意図的に新しいブランチ（例: `-2` から `-3` へ）を切り出し、連番を `001` にリセット可能。

### 5.4 GUI・操作要件

* **パラメータ入力の双方向同期**:
プレビューの露光時間・ゲイン設定において、「小数入力可能なSpinBox」と「直感的に操作可能なSlider」を相互にリアルタイム同期させる。スライダーの可動域はカメラのMin/Max仕様を動的に取得して反映する。
* **保存先参照**: GUIからダイアログで保存先 Root Directory を変更可能。
* **進捗表示**: シーケンス撮影時は全体の撮影予定枚数と現在枚数をプログレスバーで可視化する。

### 5.5 アプリケーション設定の永続化

* アプリケーション終了時に以下の項目を `settings.json` に保存し、次回起動時に自動復元する。
* Root Directoryパス
* プレビュー用露光時間 / ゲイン
* シーケンス用露光時間リスト / ゲインリスト
* CLAHE処理のON/OFF状態

## 6. データ保存仕様

### 6.1 記録形式

* **フォーマット**: 非圧縮 TIFF (`.tiff`)
* **データ型**: `uint16` (MsbAligned処理済み)
* **画像加工**: 画像処理（CLAHE等）は一切適用せず、コンバータから得た配列をそのまま書き込む。

### 6.2 メタデータ仕様

TIFFの標準タグ `ImageDescription` に、以下の情報をJSON文字列として埋め込む。

```json
{
  "exposure_ms": 10.5,
  "gain": 0.0,
  "timestamp": "2026-02-15T15:00:00.000",
  "bit_depth_sensor": 12,
  "bit_depth_saved": 16,
  "alignment": "MsbAligned"
}

```

### 6.3 ディレクトリ構造とファイル命名規則

```text
[Root_Directory] (設定で指定可)
 ├── 260215                  # その日最初の実験 (yymmdd)
 │    ├── image_001          # 1回目のシーケンス撮影
 │    │    ├── 260215-1_Exp10_Gain0.tiff   (※少数点以下の不要な0は省く)
 │    │    └── 260215-1_Exp50_Gain0.tiff
 │    └── image_002          # 2回目のシーケンス撮影
 ├── 260215-2                # 新規ブランチ(同日別実験)
 │    └── image_001

```

* **ファイル名**: `{yymmdd}{branch_suffix}-{sequence_counter}_Exp{Exposure:g}_Gain{Gain:g}.tiff`

## 7. エラー・例外処理

* **リトライ制御 (CaptureService)**:
撮影時（`GrabOne`）に `None` が返却された、または `pylon.GenericException` 等の通信エラーが発生した場合、最大 **3回** までリトライ（再取得）を行う。
* **致命的エラー時の保護**:
リトライ上限に達した場合は、シーケンス全体を中断し、ユーザーにダイアログで通知する。中断が発生した場合でも、`finally` ブロックにより必ずプレビュー機能を復帰させる（ハードウェアリソースをロックしたままにしない）。
